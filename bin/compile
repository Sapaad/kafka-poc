#!/bin/bash


indent() {
  sed -u 's/^/       /'
}

echo "-----> Found a .install_spark_odbc_drivers file"
echo "-----> Installing drivers for DSN Less ODBC connection for Databricks"

# # Bail early but noisily
# if [ ! -s $1/.vendor_urls ]; then
#   echo ".vendor_urls empty. Skipping." | indent
#   exit 0
# fi

cd $1

# echo Installing unixodbc,unixodbc-dev,freetds-dev,tdsodbc,unzip,libsasl2-modules-gssapi-mit | indent
# apt update && apt install -y unixodbc unixodbc-dev freetds-dev tdsodbc unzip libsasl2-modules-gssapi-mit

# echo Downloading SimbaSparkODBC-2.6.16.1019-Debian-64bit.zip | indent
# curl -sL https://databricks.com/wp-content/uploads/drivers-2020/SimbaSparkODBC-2.6.16.1019-Debian-64bit.zip -o databricksOdbc.zip && unzip databricksOdbc.zip

# echo Depackaging SimbaSparkODBC-2.6.16.1019-Debian-64bit/simbaspark_2.6.16.1019-2_amd64.deb | indent
# dpkg -i SimbaSparkODBC-2.6.16.1019-Debian-64bit/simbaspark_2.6.16.1019-2_amd64.deb

echo Setting ENVs ODBCINI, ODBCSYSINI, SIMBASPARKINI| indent
export ODBCINI=/etc/odbc.ini ODBCSYSINI=/etc/odbcinst.ini SIMBASPARKINI=/opt/simba/spark/lib/64/simba.sparkodbc.ini



# while read url; do
#   if [ -n "$url" ]; then # incase ensure_newline_at_eof_on_save is enabled
#     echo Vendoring $url | indent

#     extension="${url##*.}" # http://stackoverflow.com/q/965053
#     flag="-z" # by default use gz
#     if [ "$extension" == "xz" ]; then flag="--xz"
#     elif [ "$extension" == "bz2" ]; then flag="--bzip2"
#     elif [ "$extension" == "tar" ]; then flag=""  # no compression
#     fi

#     curl -L --silent $url | tar x $flag
#   fi
# done < .vendor_urls